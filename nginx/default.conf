upstream web {
  server frontend:80;
}

upstream api {
  server api:8000;
}

server {
  listen 80;
  server_name _;

  # Health check endpoint - MUST be before the redirect
  location = /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
  }
  
  # Redirect to HTTPS if not already HTTPS (check ALB header)
  if ($http_x_forwarded_proto != "https") {
      return 301 https://$host$request_uri;
  }

  include /etc/nginx/common.conf;
}